{% extends 'interface/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .lab-item {
        border: 1px solid rgba(0, 0, 0, 0.1);
        transition: background 0.5s, border 0.5s;
        margin-bottom: 1rem;
    }
    .lab-item.excluded {
        opacity: 0.5;
        background-color: #f5f5f5;
    }
    .lab-item.excluded .lab-name {
        text-decoration: line-through;
        color: #999;
    }
    .exclude-btn, .include-btn {
        cursor: pointer;
        transition: transform 0.4s, opacity 0.25s;
        display: inline-block;
    }
    .exclude-btn:hover, .include-btn:hover {
        transform: scale(1.2);
    }
    .lab-item.excluded .exclude-btn {
        transform: translateX(25px);
        opacity: 0;
        pointer-events: none;
    }
    .lab-item:not(.excluded) .include-btn {
        transform: translateX(-25px);
        opacity: 0;
        pointer-events: none;
    }
    .tasks-list {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        transition: max-height 0.75s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s, padding 0.4s;
        max-height: 1500px;
        opacity: 1;
    }
    .tasks-list.collapsed {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        padding-bottom: 0;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="columns is-centered">
    <div class="column is-full">
        <h1 class="title is-2">
            {% if creating_from_lab %}
                Создать ККЗ с включением: {{ lab.name }}
            {% else %}
                Создать контрольно-квалификационное задание
            {% endif %}
        </h1>
    </div>
</div>

<form method="post" id="kkz-form">
    {% csrf_token %}

    <div class="columns">
        <div class="column is-two-thirds">
            <div class="box" style="border: 1px solid rgba(0, 0, 0, 0.1)">
                <h3 class="title is-4">Основные параметры</h3>

                <div class="field">
                    <label class="label" for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                    <div class="control">
                        {{ form.name }}
                    </div>
                    {% if form.name.errors %}
                        <p class="help is-danger">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="field">
                    <label class="label" for="{{ form.platoon.id_for_label }}">{{ form.platoon.label }}</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            {{ form.platoon }}
                        </div>
                    </div>
                    {% if form.platoon.errors %}
                        <p class="help is-danger">{{ form.platoon.errors.0 }}</p>
                    {% endif %}
                    <p class="help">При выборе взвода автоматически загрузятся доступные лабораторные работы.</p>
                </div>

                <div class="field">
                    <label class="label" for="{{ form.duration.id_for_label }}">{{ form.duration.label }}</label>
                    <div class="durationwidget">
                        {{ form.duration }}
                    </div>
                    {% if form.duration.errors %}
                        <p class="help is-danger">{{ form.duration.errors.0 }}</p>
                    {% endif %}
                    <p class="help">Внимание! Отчёт времени начнётся с момента создания работы.</p>
                </div>

                {{ form.labs_data }}
                <input type="hidden" name="preview_assignments" id="preview-assignments">

                <div class="field">
                    <div class="control" style="display: flex; align-items: center;">
                        <button id="create-kkz-button" class="button is-info" type="submit">Создать ККЗ</button>
                        <div id="video-container" class="hidden" style="margin-left: 1rem;">
                            <video id="exam-video" style="width: auto; height: 62px; border-radius: 4px;" autoplay muted>
                                <source src="{% static 'videos/rocket_no_back.mp4' %}" type="video/mp4">
                            </video>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div id="platoon-prompt" class="box has-background-light">
                        <p class="content">Выберите взвод, чтобы загрузить список доступных лабораторных работ.</p>
                    </div>

                    <div id="labs-container">
                        <div class="box" style="border: 1px solid rgba(0, 0, 0, 0.1); margin-bottom: 1rem;">
                            <h3 class="title is-4">Лабораторные работы для выдачи</h3>
                            <p class="help mb-3">Вы можете исключить ненужные лабораторные работы.</p>

                            <div id="labs-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="column is-one-third">
            <div class="box" style="border: 1px solid rgba(0, 0, 0, 0.1); margin-bottom: 1rem;">
                <h3 class="title is-4">Параметры</h3>
                <div class="field">
                    <div class="control">
                        <label class="checkbox">
                            {{ form.unified_tasks }}
                            {{ form.unified_tasks.label }}
                        </label>
                    </div>
                    <p class="help">Если отмечено, все студенты получат одинаковые задания.</p>
                </div>

                <div class="field">
                    <label class="label">Ограничить количество заданий</label>
                    <div class="control">
                        <input type="number" class="input" id="max-tasks-limit" min="1" placeholder="Без ограничений">
                    </div>
                    <p class="help">Если указано, будет выдано не более этого количества заданий (суммарно из всех лаб).</p>
                </div>

                <div class="field">
                    <label class="checkbox">
                        <input type="checkbox" id="show-preview-checkbox">
                        Показать распределение заданий
                    </label>
                </div>

                <div id="preview-container" style="display: none; margin-top: 1rem;">
                    <div class="tabs is-boxed" id="preview-tabs">
                        <ul id="preview-tabs-list">
                        </ul>
                    </div>
                    <button type="button" id="regenerate-btn" class="button is-small is-info mb-2">
                        Перегенерировать
                    </button>
                    <div id="preview-content" class="box" style="background: #fafafa;">
                    </div>
                </div>

            </div>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const platoonSelect = document.querySelector('select[name="platoon"]') || document.getElementById('id_platoon');
    const labsContainer = document.getElementById('labs-container');
    const labsList = document.getElementById('labs-list');
    const platoonPrompt = document.getElementById('platoon-prompt');
    const labsDataInput = document.querySelector('input[name="labs_data"]') || document.getElementById('id_labs_data');
    const form = document.getElementById('kkz-form');

    if (!platoonSelect || !labsContainer || !labsList || !platoonPrompt || !labsDataInput || !form) {
        console.error('Some required elements not found:', {
            platoonSelect: !!platoonSelect,
            labsContainer: !!labsContainer,
            labsList: !!labsList,
            platoonPrompt: !!platoonPrompt,
            labsDataInput: !!labsDataInput,
            form: !!form
        });

        console.log('Form HTML:', document.querySelector('.box').innerHTML);
        return;
    }

    console.log('All elements found successfully!');

    let currentLabs = [];

    {% if creating_from_lab %}
    const initialLabId = {{ lab.id }};
    {% endif %}

    platoonSelect.addEventListener('change', function() {
        const platoonId = this.value;
        if (!platoonId) {
            labsContainer.classList.remove('loaded');
            platoonPrompt.style.display = 'block';
            return;
        }

        loadLabsForPlatoon(platoonId);
    });

    if (platoonSelect.value) {
        loadLabsForPlatoon(platoonSelect.value);
    }

    const maxTasksInput = document.getElementById('max-tasks-limit');
    if (maxTasksInput) {
        maxTasksInput.addEventListener('input', function() {
            updateHiddenField();
        });
    }

    function loadLabsForPlatoon(platoonId) {
        console.log('Loading labs for platoon:', platoonId);
        fetch(`/api/get_labs_for_platoon/?platoon_id=${platoonId}`)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);
                if (data.labs) {
                    currentLabs = data.labs.map(lab => ({
                        lab_id: lab.id,
                        name: lab.name,
                        tasks: lab.tasks,
                        included: true,
                        task_ids: lab.tasks.map(t => t.id),
                        num_tasks: lab.tasks.length
                    }));

                    renderLabs();
                    platoonPrompt.style.display = 'none';
                    labsContainer.classList.add('loaded');
                    updateHiddenField();
                }
            })
            .catch(error => {
                console.error('Error loading labs:', error);
                alert('Ошибка при загрузке лабораторных работ: ' + error.message);
            });
    }

    function renderLabs() {
        labsList.innerHTML = '';

        currentLabs.forEach((lab, index) => {
            const labBox = document.createElement('div');
            labBox.className = 'box lab-item' + (lab.included ? '' : ' excluded');
            labBox.style.marginBottom = '1rem';

            labBox.innerHTML = `
                <div class="level" style="margin-bottom: 1rem;">
                    <div class="level-left">
                        <div class="level-item">
                            <h4 class="title is-5 lab-name">${lab.name}</h4>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            ${lab.included ?
                                `<span class="icon has-text-danger exclude-btn" data-index="${index}" title="Исключить">
                                    <i class="fas fa-times-circle fa-lg"></i>
                                </span>` :
                                `<span class="icon has-text-success include-btn" data-index="${index}" title="Включить обратно">
                                    <i class="fas fa-check-circle fa-lg"></i>
                                </span>`
                            }
                        </div>
                    </div>
                </div>

                <div class="tasks-list">
                    ${lab.tasks.map((task, taskIndex) => `
                        <article class="media" style="margin-bottom: 0.75rem;">
                            <div class="media-left" style="margin-right: 0.75rem;">
                                <label class="checkbox">
                                    <input type="checkbox" class="task-checkbox"
                                           data-lab-index="${index}"
                                           data-task-id="${task.id}"
                                           ${lab.task_ids.includes(task.id) && lab.included ? 'checked' : ''}
                                           ${!lab.included ? 'disabled' : ''}>
                                </label>
                            </div>
                            <div class="media-content">
                                <div class="content">
                                    <p>
                                        <strong>Задание ${taskIndex + 1}</strong>
                                        <br>
                                        ${task.description}
                                    </p>
                                </div>
                            </div>
                        </article>
                    `).join('')}
                </div>
            `;

            labsList.appendChild(labBox);

            const tasksList = labBox.querySelector('.tasks-list');
            if (!lab.included) {
                tasksList.classList.add('collapsed');
            } else {
                tasksList.classList.remove('collapsed');
            }

        });

        document.querySelectorAll('.exclude-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                const labBox = this.closest('.lab-item');
                const tasksList = labBox.querySelector('.tasks-list');

                currentLabs[index].included = false;
                updateHiddenField();
                if (showPreviewCheckbox && showPreviewCheckbox.checked) {
                    updatePreviewAfterLabChange();
                }


                tasksList.style.maxHeight = tasksList.scrollHeight + "px";
                tasksList.offsetHeight;
                tasksList.style.maxHeight = "0";
                tasksList.style.opacity = "0";

                tasksList.addEventListener('transitionend', function handler() {
                    tasksList.removeEventListener('transitionend', handler);
                    currentLabs[index].included = false;
                    renderLabs();
                    updateHiddenField();
                });
            });
        });

        document.querySelectorAll('.include-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                const labBox = this.closest('.lab-item');
                const tasksList = labBox.querySelector('.tasks-list');

                renderLabs();

                if (showPreviewCheckbox && showPreviewCheckbox.checked) {
                    updatePreviewAfterLabChange();
                }

                requestAnimationFrame(() => {
                    const newLabBox = labsList.querySelectorAll('.lab-item')[index];
                    const newTasksList = newLabBox.querySelector('.tasks-list');
                    newTasksList.style.maxHeight = "0";
                    newTasksList.style.opacity = "0";
                    newTasksList.offsetHeight;
                    newTasksList.style.maxHeight = newTasksList.scrollHeight + "px";
                    newTasksList.style.opacity = "1";
                    setTimeout(() => {
                        newTasksList.style.maxHeight = "1500px";
                    }, 450);
                });
            });
        });

        function updatePreviewAfterLabChange() {
            const includedLabs = currentLabs.filter(lab => lab.included);

            if (includedLabs.length === 0) {
                previewContainer.style.display = 'none';
                showPreviewCheckbox.checked = false;
                return;
            }

            const currentLabStillIncluded = includedLabs.some(lab => lab.lab_id === currentPreviewLabId);
            if (!currentLabStillIncluded) {
                currentPreviewLabId = includedLabs[0].lab_id;
            }

            previewTabsList.innerHTML = includedLabs.map((lab, index) => {
                const isActive = lab.lab_id === currentPreviewLabId ? 'is-active' : '';
                return `<li class="${isActive}" data-lab-id="${lab.lab_id}">
                    <a>${lab.name}</a>
                </li>`;
            }).join('');

            previewTabsList.querySelectorAll('li').forEach(tab => {
                tab.addEventListener('click', function() {
                    const labId = parseInt(this.dataset.labId);
                    switchPreviewTab(labId);
                });
            });

            loadCombinedPreview(includedLabs);
        }


        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const labIndex = parseInt(this.dataset.labIndex);
                const taskId = parseInt(this.dataset.taskId);

                if (this.checked) {
                    if (!currentLabs[labIndex].task_ids.includes(taskId)) {
                        currentLabs[labIndex].task_ids.push(taskId);
                    }
                } else {
                    currentLabs[labIndex].task_ids = currentLabs[labIndex].task_ids.filter(id => id !== taskId);
                }

                currentLabs[labIndex].num_tasks = currentLabs[labIndex].task_ids.length;
                updateHiddenField();

                if (showPreviewCheckbox && showPreviewCheckbox.checked) {
                    updatePreviewAfterLabChange();
                }
            });
        });
    }

    function updateHiddenField() {
        const maxTasksInput = document.getElementById('max-tasks-limit');
        const maxTasks = maxTasksInput && maxTasksInput.value ? parseInt(maxTasksInput.value) : null;

        const labsDataWithLimit = currentLabs.map(lab => ({
            ...lab,
            max_tasks_limit: maxTasks
        }));

        labsDataInput.value = JSON.stringify(labsDataWithLimit);
    }

    form.addEventListener('submit', function(e) {
        const button = document.getElementById('create-kkz-button');
        const videoContainer = document.getElementById('video-container');
        const video = document.getElementById('exam-video');

        button.disabled = true;
        videoContainer.classList.remove('hidden');
        video.classList.remove('is-hidden');
        video.play();
    });

    const showPreviewCheckbox = document.getElementById('show-preview-checkbox');
    const previewContainer = document.getElementById('preview-container');
    const previewContent = document.getElementById('preview-content');
    const previewTabsList = document.getElementById('preview-tabs-list');
    const regenerateBtn = document.getElementById('regenerate-btn');

    let previewAssignments = {};
    let previewDataByLab = {};
    let currentPreviewLabId = null;

   
    if (showPreviewCheckbox) {
        showPreviewCheckbox.addEventListener('change', function() {
            if (this.checked) {
                previewContainer.style.display = 'block';
                loadAllPreviews();
            } else {
                previewContainer.style.display = 'none';
            }
        });
    }

    if (regenerateBtn) {
        regenerateBtn.addEventListener('click', function() {
            if (currentPreviewLabId) {
                loadPreviewForLab(currentPreviewLabId, true);
            }
        });
    }

   
    function loadAllPreviews() {
        const platoonId = platoonSelect.value;
        if (!platoonId) {
            previewContent.innerHTML = '<p class="help">Выберите взвод.</p>';
            return;
        }

        const includedLabs = currentLabs.filter(lab => lab.included);
        if (includedLabs.length === 0) {
            previewContent.innerHTML = '<p class="help">Нет включенных лабораторных работ.</p>';
            return;
        }

       
        previewTabsList.innerHTML = includedLabs.map((lab, index) => {
            const isActive = index === 0 ? 'is-active' : '';
            return `<li class="${isActive}" data-lab-id="${lab.lab_id}">
                <a>${lab.name}</a>
            </li>`;
        }).join('');

       
        previewTabsList.querySelectorAll('li').forEach(tab => {
            tab.addEventListener('click', function() {
                const labId = parseInt(this.dataset.labId);
                switchPreviewTab(labId);
            });
        });

       
        loadCombinedPreview(includedLabs);
    }

    function loadCombinedPreview(includedLabs) {
    const platoonId = platoonSelect.value;
    const maxTasksInput = document.getElementById('max-tasks-limit');
    const maxTasks = maxTasksInput && maxTasksInput.value ? parseInt(maxTasksInput.value) : null;
    const unified = document.querySelector('input[name="unified_tasks"]').checked;

    const allTasksWithLab = [];
    includedLabs.forEach(lab => {
        if (lab.task_ids && lab.task_ids.length > 0) {
            lab.task_ids.forEach(taskId => {
                const task = lab.tasks.find(t => t.id === taskId);
                if (task) {
                    allTasksWithLab.push({
                        ...task,
                        lab_id: lab.lab_id,
                        lab_name: lab.name
                    });
                }
            });
        }
    });

    if (allTasksWithLab.length === 0) {
        previewContent.innerHTML = '<p class="help">Нет выбранных заданий.</p>';
        return;
    }

    previewContent.innerHTML = '<p class="help">Загрузка...</p>';

    const params = new URLSearchParams({
        platoon_ids: platoonId
    });

    fetch(`/api/get_users_for_platoon/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            const users = data.users || [];
            if (users.length === 0) {
                previewContent.innerHTML = '<p class="help">Нет студентов во взводе.</p>';
                return;
            }

            const totalTasksToAssign = maxTasks && maxTasks > 0
                ? Math.min(maxTasks, allTasksWithLab.length)
                : allTasksWithLab.length;

            const assignments = {};
            if (unified) {
                const selectedTasks = shuffleArray([...allTasksWithLab]).slice(0, totalTasksToAssign);
                users.forEach(user => {
                    assignments[user.id] = selectedTasks;
                });
            } else {
                users.forEach(user => {
                    const selectedTasks = shuffleArray([...allTasksWithLab]).slice(0, totalTasksToAssign);
                    assignments[user.id] = selectedTasks;
                });
            }

            previewAssignments = {};
            previewDataByLab = {};

            includedLabs.forEach(lab => {
                const labId = lab.lab_id;
                previewDataByLab[labId] = {
                    lab: { id: labId, name: lab.name },
                    tasks: lab.tasks,
                    users: users.map(user => ({
                        id: user.id,
                        username: user.username,
                        display: user.full_name || user.username
                    }))
                };

                previewAssignments[labId] = {};
                users.forEach(user => {
                    const userTasks = assignments[user.id] || [];
                    const labTaskIds = userTasks
                        .filter(t => t.lab_id === labId)
                        .map(t => t.id);
                    previewAssignments[labId][user.id] = labTaskIds;
                });
            });

            currentPreviewLabId = includedLabs[0].lab_id;
            renderPreview(previewDataByLab[currentPreviewLabId], currentPreviewLabId);
        })
        .catch(error => {
            console.error('Error loading preview:', error);
            previewContent.innerHTML = '<p class="help has-text-danger">Ошибка загрузки превью.</p>';
        });
    }

    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    if (regenerateBtn) {
        regenerateBtn.addEventListener('click', function() {
            const includedLabs = currentLabs.filter(lab => lab.included);
            if (includedLabs.length > 0) {
                loadCombinedPreview(includedLabs);
            }
        });
    }

   
    function switchPreviewTab(labId) {
       
        previewTabsList.querySelectorAll('li').forEach(tab => {
            if (parseInt(tab.dataset.labId) === labId) {
                tab.classList.add('is-active');
            } else {
                tab.classList.remove('is-active');
            }
        });

        currentPreviewLabId = labId;

       
        if (previewDataByLab[labId]) {
            renderPreview(previewDataByLab[labId], labId);
        } else {
            loadPreviewForLab(labId);
        }
    }

   
    function loadPreviewForLab(labId, forceRegen = false) {
        const platoonId = platoonSelect.value;
        const lab = currentLabs.find(l => l.lab_id === labId);

        if (!lab || !lab.included) {
            previewContent.innerHTML = '<p class="help">Лаба не найдена или исключена.</p>';
            return;
        }

        const taskIds = lab.task_ids || [];
        if (taskIds.length === 0) {
            previewContent.innerHTML = '<p class="help">Нет выбранных заданий для этой лабы.</p>';
            return;
        }

        const maxTasksInput = document.getElementById('max-tasks-limit');
        const maxTasks = maxTasksInput && maxTasksInput.value ? parseInt(maxTasksInput.value) : taskIds.length;
        const unified = document.querySelector('input[name="unified_tasks"]').checked;

        const params = new URLSearchParams({
            lab_id: labId,
            platoon_ids: platoonId,
            num_tasks: maxTasks,
            unified: unified ? 'true' : 'false',
            selected_tasks: taskIds.join(',')
        });

        if (forceRegen) {
            params.append('force_regen', 'true');
        }

        previewContent.innerHTML = '<p class="help">Загрузка...</p>';

        fetch(`/api/kkz_preview_random/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                previewDataByLab[labId] = data;

                if (!previewAssignments[labId]) {
                    previewAssignments[labId] = {};
                }
                previewAssignments[labId] = data.assignments || {};

                renderPreview(data, labId);
            })
            .catch(error => {
                console.error('Error loading preview:', error);
                previewContent.innerHTML = '<p class="help has-text-danger">Ошибка загрузки превью.</p>';
            });
    }

   
    function renderPreview(data, labId) {
        if (!data.users || data.users.length === 0) {
            previewContent.innerHTML = '<p class="help">Нет студентов во взводе.</p>';
            return;
        }

        const assignments = previewAssignments[labId] || data.assignments || {};
        let html = `<p class="help mb-2"><strong>Студентов:</strong> ${data.users.length}</p>`;

        data.users.forEach(user => {
            const assigned = assignments[user.id] || [];
            html += `
                <div class="box" style="padding: 0.75rem; margin-bottom: 0.5rem; background: #f9f9f9;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${user.display || user.username}</div>
                    <div class="select is-multiple is-small" style="width: 100%;">
                        <select multiple data-user-id="${user.id}" data-lab-id="${labId}" class="preview-task-select" style="width: 100%; height: 80px;">
                            ${data.tasks.map(task => {
                                const selected = assigned.includes(task.id) ? 'selected' : '';
                                return `<option value="${task.id}" ${selected}>${task.description}</option>`;
                            }).join('')}
                        </select>
                    </div>
                </div>
            `;
        });

        previewContent.innerHTML = html;

       
        document.querySelectorAll('.preview-task-select').forEach(select => {
            select.addEventListener('change', function() {
                const userId = this.dataset.userId;
                const labId = parseInt(this.dataset.labId);
                const selectedTasks = Array.from(this.selectedOptions).map(opt => parseInt(opt.value));

                if (!previewAssignments[labId]) {
                    previewAssignments[labId] = {};
                }
                previewAssignments[labId][userId] = selectedTasks;

                console.log(`Updated assignments for lab ${labId}, user ${userId}:`, selectedTasks);
            });
        });
    }

   
    const unifiedCheckbox = document.querySelector('input[name="unified_tasks"]');
    if (unifiedCheckbox) {
        unifiedCheckbox.addEventListener('change', function() {
            if (showPreviewCheckbox.checked) {
                previewDataByLab = {};
                loadAllPreviews();
            }
        });
    }

    if (maxTasksInput) {
        maxTasksInput.addEventListener('change', function() {
            if (showPreviewCheckbox.checked) {
                previewDataByLab = {};
                loadAllPreviews();
            }
        });
    }
});
</script>

{% endblock %}