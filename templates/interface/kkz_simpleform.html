{% extends 'interface/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .lab-item {
        border: 1px solid rgba(0, 0, 0, 0.1);
        transition: background 0.5s, border 0.5s;
        margin-bottom: 1rem;
    }
    .lab-item.excluded {
        opacity: 0.5;
        background-color: #f5f5f5;
    }
    .lab-item.excluded .lab-name {
        text-decoration: line-through;
        color: #999;
    }
    .exclude-btn, .include-btn {
        cursor: pointer;
        transition: transform 0.4s, opacity 0.25s;
        display: inline-block;
    }
    .exclude-btn:hover, .include-btn:hover {
        transform: scale(1.2);
    }
    .lab-item.excluded .exclude-btn {
        transform: translateX(25px);
        opacity: 0;
        pointer-events: none;
    }
    .lab-item:not(.excluded) .include-btn {
        transform: translateX(-25px);
        opacity: 0;
        pointer-events: none;
    }
    .tasks-list {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        transition: max-height 0.75s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s, padding 0.4s;
        max-height: 1500px;
        opacity: 1;
    }
    .tasks-list.collapsed {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        padding-bottom: 0;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="columns is-centered">
    <div class="column is-full">
        <h1 class="title is-2">
            {% if creating_from_lab %}
                Создать ККЗ с включением: {{ lab.name }}
            {% else %}
                Создать контрольно-квалификационное задание
            {% endif %}
        </h1>
    </div>
</div>

<form method="post" id="kkz-form">
    {% csrf_token %}

    <div class="columns">
        <div class="column is-two-thirds">
            <div class="box" style="border: 1px solid rgba(0, 0, 0, 0.1)">
                <h3 class="title is-4">Основные параметры</h3>

                <div class="field">
                    <label class="label" for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                    <div class="control">
                        {{ form.name }}
                    </div>
                    {% if form.name.errors %}
                        <p class="help is-danger">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="field">
                    <label class="label" for="{{ form.platoon.id_for_label }}">{{ form.platoon.label }}</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            {{ form.platoon }}
                        </div>
                    </div>
                    {% if form.platoon.errors %}
                        <p class="help is-danger">{{ form.platoon.errors.0 }}</p>
                    {% endif %}
                    <p class="help">При выборе взвода автоматически загрузятся доступные лабораторные работы.</p>
                </div>

                <div class="field">
                    <label class="label" for="{{ form.duration.id_for_label }}">{{ form.duration.label }}</label>
                    <div class="durationwidget">
                        {{ form.duration }}
                    </div>
                    {% if form.duration.errors %}
                        <p class="help is-danger">{{ form.duration.errors.0 }}</p>
                    {% endif %}
                    <p class="help">Внимание! Отчёт времени начнётся с момента создания работы.</p>
                </div>

                {{ form.labs_data }}

                <div class="field">
                    <div class="control" style="display: flex; align-items: center;">
                        <button id="create-kkz-button" class="button is-info" type="submit">Создать ККЗ</button>
                        <div id="video-container" class="hidden" style="margin-left: 1rem;">
                            <video id="exam-video" style="width: auto; height: 62px; border-radius: 4px;" autoplay muted>
                                <source src="{% static 'videos/rocket_no_back.mp4' %}" type="video/mp4">
                            </video>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div id="platoon-prompt" class="box has-background-light">
                        <p class="content">Выберите взвод, чтобы загрузить список доступных лабораторных работ.</p>
                    </div>

                    <div id="labs-container">
                        <div class="box" style="border: 1px solid rgba(0, 0, 0, 0.1); margin-bottom: 1rem;">
                            <h3 class="title is-4">Лабораторные работы для выдачи</h3>
                            <p class="help mb-3">Вы можете исключить ненужные лабораторные работы.</p>

                            <div id="labs-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="column is-one-third">
            <div class="box" style="border: 1px solid rgba(0, 0, 0, 0.1); margin-bottom: 1rem;">
                <h3 class="title is-4">Параметры</h3>
                <div class="field">
                    <div class="control">
                        <label class="checkbox">
                            {{ form.unified_tasks }}
                            {{ form.unified_tasks.label }}
                        </label>
                    </div>
                    <p class="help">Если отмечено, все студенты получат одинаковые задания.</p>
                </div>

                <div class="field">
                    <label >Ограничить количество заданий</label>
                    <div class="control">
                        <input type="number" class="input is-small" style="width: 150px;" id="max-tasks-limit" min="1" placeholder="Без ограничений">
                    </div>
                    <p class="help">Если указано, суммарно будет выдано не более этого количества заданий.</p>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const platoonSelect = document.querySelector('select[name="platoon"]') || document.getElementById('id_platoon');
    const labsContainer = document.getElementById('labs-container');
    const labsList = document.getElementById('labs-list');
    const platoonPrompt = document.getElementById('platoon-prompt');
    const labsDataInput = document.querySelector('input[name="labs_data"]') || document.getElementById('id_labs_data');
    const form = document.getElementById('kkz-form');

    
    if (!platoonSelect || !labsContainer || !labsList || !platoonPrompt || !labsDataInput || !form) {
        console.error('Some required elements not found:', {
            platoonSelect: !!platoonSelect,
            labsContainer: !!labsContainer,
            labsList: !!labsList,
            platoonPrompt: !!platoonPrompt,
            labsDataInput: !!labsDataInput,
            form: !!form
        });

        
        console.log('Form HTML:', document.querySelector('.box').innerHTML);
        return;
    }

    console.log('All elements found successfully!');

    let currentLabs = [];

    {% if creating_from_lab %}
    
    const initialLabId = {{ lab.id }};
    {% endif %}

    
    platoonSelect.addEventListener('change', function() {
        const platoonId = this.value;
        if (!platoonId) {
            labsContainer.classList.remove('loaded');
            platoonPrompt.style.display = 'block';
            return;
        }

        loadLabsForPlatoon(platoonId);
    });

    
    if (platoonSelect.value) {
        loadLabsForPlatoon(platoonSelect.value);
    }

    
    const maxTasksInput = document.getElementById('max-tasks-limit');
    if (maxTasksInput) {
        maxTasksInput.addEventListener('input', function() {
            updateHiddenField();
        });
    }

    function loadLabsForPlatoon(platoonId) {
        console.log('Loading labs for platoon:', platoonId);
        fetch(`/api/get_labs_for_platoon/?platoon_id=${platoonId}`)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);
                if (data.labs) {
                    currentLabs = data.labs.map(lab => ({
                        lab_id: lab.id,
                        name: lab.name,
                        tasks: lab.tasks,
                        included: true,
                        task_ids: lab.tasks.map(t => t.id),
                        num_tasks: lab.tasks.length
                    }));

                    renderLabs();
                    platoonPrompt.style.display = 'none';
                    labsContainer.classList.add('loaded');
                    updateHiddenField();
                }
            })
            .catch(error => {
                console.error('Error loading labs:', error);
                alert('Ошибка при загрузке лабораторных работ: ' + error.message);
            });
    }

    function renderLabs() {
        labsList.innerHTML = '';

        currentLabs.forEach((lab, index) => {
            const labBox = document.createElement('div');
            labBox.className = 'box lab-item' + (lab.included ? '' : ' excluded');
            labBox.style.marginBottom = '1rem';

            labBox.innerHTML = `
                <div class="level" style="margin-bottom: 1rem;">
                    <div class="level-left">
                        <div class="level-item">
                            <h4 class="title is-5 lab-name">${lab.name}</h4>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            ${lab.included ?
                                `<span class="icon has-text-danger exclude-btn" data-index="${index}" title="Исключить">
                                    <i class="fas fa-times-circle fa-lg"></i>
                                </span>` :
                                `<span class="icon has-text-success include-btn" data-index="${index}" title="Включить обратно">
                                    <i class="fas fa-check-circle fa-lg"></i>
                                </span>`
                            }
                        </div>
                    </div>
                </div>

                <div class="tasks-list">
                    ${lab.tasks.map((task, taskIndex) => `
                        <article class="media" style="margin-bottom: 0.75rem;">
                            <div class="media-left" style="margin-right: 0.75rem;">
                                <label class="checkbox">
                                    <input type="checkbox" class="task-checkbox"
                                           data-lab-index="${index}"
                                           data-task-id="${task.id}"
                                           ${lab.task_ids.includes(task.id) && lab.included ? 'checked' : ''}
                                           ${!lab.included ? 'disabled' : ''}>
                                </label>
                            </div>
                            <div class="media-content">
                                <div class="content">
                                    <p>
                                        <strong>Задание ${taskIndex + 1}</strong>
                                        <br>
                                        ${task.description}
                                    </p>
                                </div>
                            </div>
                        </article>
                    `).join('')}
                </div>
            `;

            labsList.appendChild(labBox);

            const tasksList = labBox.querySelector('.tasks-list');
            if (!lab.included) {
                tasksList.classList.add('collapsed');
            } else {
                tasksList.classList.remove('collapsed');
            }

        });

        document.querySelectorAll('.exclude-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                const labBox = this.closest('.lab-item');
                const tasksList = labBox.querySelector('.tasks-list');

                
                tasksList.style.maxHeight = tasksList.scrollHeight + "px";
                tasksList.offsetHeight; 
                tasksList.style.maxHeight = "0";
                tasksList.style.opacity = "0";

                
                tasksList.addEventListener('transitionend', function handler() {
                    tasksList.removeEventListener('transitionend', handler);
                    currentLabs[index].included = false;
                    renderLabs();
                    updateHiddenField();
                });
            });
        });

        document.querySelectorAll('.include-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                const labBox = this.closest('.lab-item');
                const tasksList = labBox.querySelector('.tasks-list');

                
                currentLabs[index].included = true;
                renderLabs();
                updateHiddenField();

                
                requestAnimationFrame(() => {
                    const newLabBox = labsList.querySelectorAll('.lab-item')[index];
                    const newTasksList = newLabBox.querySelector('.tasks-list');
                    newTasksList.style.maxHeight = "0";
                    newTasksList.style.opacity = "0";
                    newTasksList.offsetHeight; 
                    newTasksList.style.maxHeight = newTasksList.scrollHeight + "px";
                    newTasksList.style.opacity = "1";
                    setTimeout(() => {
                        newTasksList.style.maxHeight = "1500px"; 
                    }, 450);
                });
            });
        });


        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const labIndex = parseInt(this.dataset.labIndex);
                const taskId = parseInt(this.dataset.taskId);

                if (this.checked) {
                    if (!currentLabs[labIndex].task_ids.includes(taskId)) {
                        currentLabs[labIndex].task_ids.push(taskId);
                    }
                } else {
                    currentLabs[labIndex].task_ids = currentLabs[labIndex].task_ids.filter(id => id !== taskId);
                }

                currentLabs[labIndex].num_tasks = currentLabs[labIndex].task_ids.length;
                updateHiddenField();
            });
        });
    }

    function updateHiddenField() {
        const maxTasksInput = document.getElementById('max-tasks-limit');
        const maxTasks = maxTasksInput && maxTasksInput.value ? parseInt(maxTasksInput.value) : null;

        
        const labsDataWithLimit = currentLabs.map(lab => ({
            ...lab,
            max_tasks_limit: maxTasks
        }));

        labsDataInput.value = JSON.stringify(labsDataWithLimit);
    }

    form.addEventListener('submit', function(e) {
        const button = document.getElementById('create-kkz-button');
        const videoContainer = document.getElementById('video-container');
        const video = document.getElementById('exam-video');

        button.disabled = true;
        videoContainer.classList.remove('hidden');
        video.classList.remove('is-hidden');
        video.play();
    });
});
</script>

{% endblock %}