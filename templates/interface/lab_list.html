{% extends 'interface/base.html' %}
{% load static %}
{% load utm_filters %}

{% block content %}
    <div class="block">
        <!-- Заголовок с переключаемыми вкладками программ -->
        <div class="has-text-centered mb-5">
            <div class="tabs is-centered is-large">
                <ul id="program-tabs">
                    {% for program_key, program_data in programs_data.items %}
                        <li class="program-tab" data-program="{{ program_key }}" onclick="switchProgram('{{ program_key }}')">
                            <a class="has-text-weight-bold is-size-4 px-5 py-3">
                                <span>{{ program_data.label }}</span>
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Контейнеры для карточек каждой программы -->
        {% for program_key, program_data in programs_data.items %}
            <div class="program-content columns is-multiline" 
                 data-program="{{ program_key }}" 
                 style="display: none;">
                {% for lab_bundle in program_data.bundles %}
                    <div class="column is-3-desktop is-6-tablet is-12-mobile">
                        <div class="card lab-card">
                            <div class="card-image">
                                <figure class="image">
                                    {% if lab_bundle.cover %}
                                        <img src="{{ lab_bundle.cover.url }}"
                                            alt="{{ lab_bundle.name }}"
                                            class="lab-icon" style="height:15vh !important; width:100%; object-fit: cover; opacity:0.9;">
                                    {% else %}
                                        <img src="{% static 'images/computers.jpg' %}"
                                            alt="{{ lab_bundle.name }}"
                                            class="lab-icon" style="height:15vh !important; width:100%; object-fit: cover; opacity:0.7;">
                                    {% endif %}
                                </figure>
                            </div>

                            <div class="card-content">
                                <h3 class="title is-4 has-text-centered mb-3">{{ lab_bundle.name }}</h3>

                                <div class="buttons is-centered mt-4">
                                    {% for type, lab in lab_bundle.labs.items %}
                                        {% if lab %}
                                            <a href="{% url 'interface:lab-detail' lab.slug lab.lab_type %}"
                                            class="button {{ lab.lab_type|lab_type_class }} is-small is-rounded action-button">
                                            <span class="icon is-small"><i class="fas fa-flask"></i></span>
                                                <span>{{ lab.get_lab_type_display }}</span>
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="column is-12">
                        <div class="notification is-info has-text-centered">
                            Лабораторных работ нет.
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

    <!-- Стили -->
    <style>
        .lab-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
            height: 100%;
            display: flex; 
            flex-direction: column;
        }
        .lab-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }

        .lab-icon {
            object-fit: cover;
            opacity: 0.9;
        }

        .lab-icon-default {
            opacity: 0.7;
        }

        .lab-description {
            color: #b5b5b5;
            font-size: 0.9rem;
        }

        .action-button {
            transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
        }
        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .action-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 6px rgba(0,0,0,0.18);
            filter: brightness(0.96);
        }

        /* Подсказка пользователю */
        .lab-card .card-content::after {
            content: '☝ Нажмите на кнопку для перехода';
            display: block;
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .lab-card:hover .card-content::after {
            opacity: 1;
        }

        /* Стили для вкладок программ */
        .program-tab {
            cursor: pointer;
        }

        .program-tab a {
            border: 2px solid hsl(0, 0%, 86%) !important;
            border-radius: 12px;
            margin: 0 0.5rem;
            transition: all 0.2s ease;
            background-color: hsl(0, 0%, 96%);
            color: hsl(0, 0%, 21%) !important;
        }

        .program-tab:hover:not(.is-active) a {
            background-color: hsl(0, 0%, 91%);
            border-color: hsl(0, 0%, 71%) !important;
        }

        .program-tab.is-active a {
            background-color: hsl(0, 0%, 21%) !important;
            color: hsl(0, 0%, 100%) !important;
            border-color: hsl(0, 0%, 21%) !important;
            box-shadow: 0 0.5rem 1rem rgba(10, 10, 10, 0.15);
        }

        /* Анимация появления/исчезновения контента */
        .program-content {
            opacity: 0;
            transition: opacity 0.25s ease-in-out;
        }

        .program-content.visible {
            opacity: 1;
        }
    </style>

    <!-- JavaScript для переключения программ -->
    <script>
        let currentProgram = null;

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Получаем параметр program из URL
            const urlParams = new URLSearchParams(window.location.search);
            const programParam = urlParams.get('program');
            
            // Определяем начальную программу
            const initialProgram = programParam || '{{ initial_program }}';
            
            // Показываем соответствующую программу
            if (initialProgram) {
                switchProgram(initialProgram, false);
            }
        });

        function switchProgram(programKey, updateUrl = true) {
            // Если уже активна эта программа, ничего не делаем
            if (currentProgram === programKey) {
                return;
            }

            const oldProgram = currentProgram;
            currentProgram = programKey;

            // Обновляем активность вкладок (используем класс Bulma is-active)
            document.querySelectorAll('.program-tab').forEach(tab => {
                if (tab.dataset.program === programKey) {
                    tab.classList.add('is-active');
                } else {
                    tab.classList.remove('is-active');
                }
            });

            // Получаем элементы контента
            const allContents = document.querySelectorAll('.program-content');
            const newContent = document.querySelector(`.program-content[data-program="${programKey}"]`);
            
            // Скрываем все контенты кроме нового
            allContents.forEach(content => {
                if (content !== newContent) {
                    content.classList.remove('visible');
                    // Скрываем через небольшую задержку после анимации
                    setTimeout(() => {
                        if (!content.classList.contains('visible')) {
                            content.style.display = 'none';
                        }
                    }, 250);
                }
            });

            // Показываем новый контент
            if (newContent) {
                newContent.style.display = 'flex';
                // Принудительный reflow для корректной работы transition
                void newContent.offsetHeight;
                newContent.classList.add('visible');
            }

            // Обновляем URL с параметром program
            if (updateUrl) {
                const url = new URL(window.location);
                url.searchParams.set('program', programKey);
                window.history.pushState({}, '', url);
            }
        }
    </script>
{% endblock %}