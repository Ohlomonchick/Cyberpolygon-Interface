
{% extends 'interface/base.html' %}


{% block content %}
    <div class="columns is-centered">
        <div class="column is-two-thirds">
        {% if available  %}
            <h1 class="title is-2">{{ object.lab.name }}</h1>
            <div class="column is-one-quarter p-0 mb-4">
                <div id="timer" class="message is-dark">
                    <div class="message-body">
                    <h2 class="has-text-weight-bold">Оставшееся время:</h2>
                    <div id="countdown" class="has-text-weight-bold has-text-danger">{{ delta.hours }} <span>:</span>
                         {{ delta.minutes }} <span>:</span>
                         {{ delta.seconds }}
                    </div>

                    </div>
                </div>
            </div>
            {% if progress %}
                <progress class="progress is-success" value="{{ progress }}" max="100">{{ progress }}%</progress>
            {% endif %}
            {% if solutions %}
                <div id="competition-slug" data-slug="{{ object.slug }}">
                    <table class="table">
                      <thead>
                        <tr>
                            <th><abbr title="Позиция">Поз.</abbr></th>
                            <th>Имя</th>
                            <th>Фамилия</th>
                            <th>Взвод</th>
                            <th>Затраченное время</th>
                            <th>Время сдачи</th>
                        </tr>
                      </thead>
                      <tbody  id="solutions-table">
                      {% for solution in solutions %}
                        <tr>
                          <th>{{ solution.pos }}</th>
                          <td>{{ solution.user.first_name }}</td>
                          <td>{{ solution.user.last_name }}</td>
                          <td>{{ solution.user.platoon }}</td>
                          <td>{{ solution.spent }}</td>
                          <td>{{ solution.datetime }}</td>
                        </tr>
                      {% endfor  %}
                      </tbody>
                    </table>
                </div>
            {% endif %}
            {% with object=object.lab %}
                {% include 'interface/lab_data.html' %}
            {% endwith %}
        {% else  %}
            <div class="notification is-warning is-light">
                <h1 class="subtitle is-4">Экзамен станет доступен: {{ object.start }}</h1>
            </div>
        {% endif %}
        </div>
    </div>


    <script>
        function refreshSolutions() {
            var competitionSlug = document.getElementById('competition-slug').getAttribute('data-slug');
            console.log();
            $.ajax({
                url: `/api/get_competition_solutions/${competitionSlug}/`,
                type: 'GET',
                success: function(response) {
                    var tableBody = document.querySelector('#solutions-table');
                    tableBody.innerHTML = '';

                    response.solutions.forEach(function(solution) {
                        var row = document.createElement('tr');
                        row.innerHTML = `
                             <th>${solution.pos}</th>
                             <td>${solution.user_first_name}</td>
                             <td>${solution.user_last_name}</td>
                             <td>${solution.user_platoon}</td>
                             <td>${solution.spent}</td>
                             <td>${solution.datetime}</td>
                             `;
                        tableBody.appendChild(row);
                    });
                },
                error: function(xhr, status, error) {
                    console.error("Error loading solutions:", error);
                }
            });
        }

        setInterval(refreshSolutions, 1000);
    </script>


    <script>
        window.onload = function() {
        if (localStorage.getItem('final') === 'true') {
            final = true;
        } else {
            final = false;
        }
            fetchTime();
            refreshSolutions();
        }

        function updateTimer() {
            var hours = parseInt(document.getElementById('countdown').textContent.split(':')[0]);
            var minutes = parseInt(document.getElementById('countdown').textContent.split(':')[1]);
            var seconds = parseInt(document.getElementById('countdown').textContent.split(':')[2]);

            if (seconds > 0) {
                seconds--;
            } else {
                if (minutes > 0) {
                    minutes--;
                    seconds = 59;
                } else {
                    if (hours > 0) {
                        hours--;
                        minutes = 59;
                        seconds = 59;
                    } else {
                        if (!final) {
                            {% if available and not solutions %}
                                location.reload();
                            {% endif %}
                            final = true;
                            localStorage.setItem('final', 'true');
                        }
                    }
                }
            }

            // Update the timer display
            document.getElementById('countdown').textContent =
                (hours < 10 ? '0' : '') + hours + ' : ' +
                (minutes < 10 ? '0' : '') + minutes + ' : ' +
                (seconds < 10 ? '0' : '') + seconds;
        }


        function fetchTime() {
            // Get the competition ID from the template (assuming you pass it in context)
            var competitionId = "{{ object.pk }}";

            // Make an AJAX GET request to fetch the remaining time
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '{% url 'get_time' competition_id=object.id %}', true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);

                    // Update the timer display with new time
                    document.getElementById('countdown').textContent =
                        (response.hours < 10 ? '0' : '') + response.hours + ' : ' +
                        (response.minutes < 10 ? '0' : '') + response.minutes + ' : ' +
                        (response.seconds < 10 ? '0' : '') + response.seconds;
                }
            };
            xhr.send();
        }
        window.onload = function() {
            fetchTime();
            refreshSolutions();
        }

        // Update the timer every second
        setInterval(updateTimer, 1000);
        setInterval(fetchTime, 30000);
    </script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
{% endblock %}
